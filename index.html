<!DOCTYPE html>
    <html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottery App - 10 Players Draw</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé∞</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
    <script type="module">
        // ÂØºÂÖ• Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, query, where, getDocs, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-functions.js';
        
        // Firebase ÈÖçÁΩÆ
        const firebaseConfig = {
            apiKey: "AIzaSyA5Z5ieEbAcfQX0kxGSn9ldGXhzvAwx_8M",
            authDomain: "chat-294cc.firebaseapp.com",
            databaseURL: "https://chat-294cc-default-rtdb.firebaseio.com",
            projectId: "chat-294cc",
            storageBucket: "chat-294cc.appspot.com",
            messagingSenderId: "913615304269",
            appId: "1:913615304269:web:0274ffaccb8e6b678e4e04",
            measurementId: "G-SJR9NDW86B"
        };
        
        // ÂàùÂßãÂåñ Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        
        // Â∞Ü Firebase ÂÆû‰æãÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.firebase = {
            app: () => ({ functions: () => functions }),
            functions: () => functions,
            auth: () => auth,
            firestore: () => db
        };
        
        // Êö¥Èú≤ÂÖ∂‰ªñÂøÖË¶ÅÁöÑÂáΩÊï∞
        window.firebaseAuth = { signInAnonymously, onAuthStateChanged };
        window.firebaseFirestore = { collection, addDoc, doc, setDoc, getDoc, query, where, getDocs, orderBy, limit, onSnapshot };
        window.firebaseFunctions = { httpsCallable };
        
        // ÂàõÂª∫Ê≠£Á°ÆÁöÑFirestoreÊìç‰ΩúÂåÖË£ÖÂô®
        window.firestore = {
            collection: (name) => ({
                doc: (id) => ({
                    onSnapshot: (callback) => onSnapshot(doc(db, name, id), callback),
                    get: () => getDoc(doc(db, name, id)),
                    update: (data) => setDoc(doc(db, name, id), data, { merge: true }),
                    set: (data) => setDoc(doc(db, name, id), data)
                }),
                add: (data) => addDoc(collection(db, name), data),
                where: (field, op, value) => ({
                    get: () => getDocs(query(collection(db, name), where(field, op, value))),
                    onSnapshot: (callback) => onSnapshot(query(collection(db, name), where(field, op, value)), callback),
                    orderBy: (orderField, direction = 'asc') => ({
                        limit: (limitCount) => ({
                            get: () => getDocs(query(collection(db, name), where(field, op, value), orderBy(orderField, direction), limit(limitCount))),
                            onSnapshot: (callback) => onSnapshot(query(collection(db, name), where(field, op, value), orderBy(orderField, direction), limit(limitCount)), callback)
                        }),
                        get: () => getDocs(query(collection(db, name), where(field, op, value), orderBy(orderField, direction))),
                        onSnapshot: (callback) => onSnapshot(query(collection(db, name), where(field, op, value), orderBy(orderField, direction)), callback)
                    }),
                    limit: (limitCount) => ({
                        get: () => getDocs(query(collection(db, name), where(field, op, value), limit(limitCount))),
                        onSnapshot: (callback) => onSnapshot(query(collection(db, name), where(field, op, value), limit(limitCount)), callback)
                    })
                }),
                orderBy: (orderField, direction = 'asc') => ({
                    limit: (limitCount) => ({
                        get: () => getDocs(query(collection(db, name), orderBy(orderField, direction), limit(limitCount))),
                        onSnapshot: (callback) => onSnapshot(query(collection(db, name), orderBy(orderField, direction), limit(limitCount)), callback)
                    }),
                    get: () => getDocs(query(collection(db, name), orderBy(orderField, direction))),
                    onSnapshot: (callback) => onSnapshot(query(collection(db, name), orderBy(orderField, direction)), callback)
                }),
                limit: (limitCount) => ({
                    get: () => getDocs(query(collection(db, name), limit(limitCount))),
                    onSnapshot: (callback) => onSnapshot(query(collection(db, name), limit(limitCount)), callback)
                }),
                onSnapshot: (callback) => onSnapshot(collection(db, name), callback)
            })
        };
        
        // Firebase SDK ÂàùÂßãÂåñÂÆåÊàêÔºåÈÄöÁü•‰∏ªËÑöÊú¨
        if (typeof onFirebaseReady === 'function') {
            onFirebaseReady();
        }
        
        // Set a flag to indicate Firebase is ready
        window.firebaseReady = true;
    </script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        memeYellow: '#FFDD00',
                        memePink: '#FF2E93',
                        memeBlue: '#00A3FF',
                        memeGreen: '#00E08E',
                        memePurple: '#9D4EDD',
                        memeBlack: '#121212',
                    },
                    fontFamily: {
                        meme: ['"Comic Sans MS"', '"Comic Neue"', 'cursive'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'spin': 'spin 1s linear infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translateX(-1px)' },
                            '20%, 80%': { transform: 'translateX(2px)' },
                            '30%, 50%, 70%': { transform: 'translateX(-4px)' },
                            '40%, 60%': { transform: 'translateX(4px)' },
                        }
                    }
                },
            }
        }
    </script>
    <style>
        .text-shadow { text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .border-meme { border-color: #FFDD00; }
        .rotate-random { transform: rotate(var(--rotation, 0deg)); }
        .bg-gradient-meme { background: linear-gradient(135deg, #FFDD00 0%, #FF2E93 100%); }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
        
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    </style>
</head>
<body class="bg-gray-100 font-meme">
    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-memeYellow border-b-4 border-black shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="text-4xl">üé∞</div>
                <h1 class="text-2xl md:text-3xl font-bold text-shadow">Lottery App</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="open-rules" class="bg-memeBlue hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg border-2 border-black transform hover:scale-105 transition-all">
                    <i class="fa fa-book mr-2"></i> Rules
                </button>
                <button id="open-history" class="bg-memeGreen hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg border-2 border-black transform hover:scale-105 transition-all">
                    <i class="fa fa-history mr-2"></i> History
                </button>
                <button id="wallet-connect" class="bg-memePink hover:bg-pink-600 text-white font-bold py-3 px-6 rounded-lg border-2 border-black transform hover:scale-105 transition-all shadow-md">
                    <i class="fa fa-wallet mr-2"></i> Connect Wallet
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="pt-20 pb-16 bg-gradient-to-br from-memeYellow via-memePink to-memeBlue">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-5xl md:text-7xl font-bold mb-6 text-white text-shadow">
                üé∞ Lottery Game üé∞
            </h1>
            <p class="text-xl md:text-2xl mb-8 text-white font-semibold">
                Join the 10-player draw and win big prizes!
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                <button id="buy-tickets-btn" class="bg-memeGreen hover:bg-green-600 text-black font-bold py-4 px-8 rounded-xl border-4 border-black transform hover:scale-105 transition-all shadow-xl text-xl">
                    <i class="fa fa-ticket mr-2"></i> Buy Tickets Now
                </button>
                <div class="text-white text-lg">
                    <span class="font-bold">Current OKB Price:</span>
                    <span id="okb-price" class="ml-2 font-bold text-2xl">$1.00</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Ticket Levels -->
    <section id="ticket-levels" class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold mb-2 text-memeBlack text-shadow">Buy <span class="text-memePink">Tickets</span></h2>
                <p class="text-xl text-gray-600">Choose your ticket level and join the draw!</p>
            </div>
            
            <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Basic Ticket -->
                <div class="bg-white p-8 rounded-2xl border-4 border-black shadow-xl transform rotate-random hover:scale-105 transition-all">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">üé´</div>
                        <h3 class="text-2xl font-bold text-memeBlue">Basic Ticket</h3>
                        <div class="text-4xl font-bold text-memeGreen mt-2">1U</div>
                        <p class="text-gray-600 mt-2">Entry level ticket</p>
                    </div>
                    <button class="buy-ticket-btn w-full bg-memeGreen hover:bg-green-600 text-black font-bold py-3 px-6 rounded-xl border-2 border-black transform hover:scale-105 transition-all" data-amount="1">
                        Buy for 1U
                    </button>
                </div>
                
                <!-- Premium Ticket -->
                <div class="bg-white p-8 rounded-2xl border-4 border-black shadow-xl transform rotate-random hover:scale-105 transition-all" style="--rotation: 1deg">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">üé∞</div>
                        <h3 class="text-2xl font-bold text-memePink">Premium Ticket</h3>
                        <div class="text-4xl font-bold text-memePurple mt-2">5U</div>
                        <p class="text-gray-600 mt-2">Better chances</p>
                    </div>
                    <button class="buy-ticket-btn w-full bg-memePink hover:bg-pink-600 text-white font-bold py-3 px-6 rounded-xl border-2 border-black transform hover:scale-105 transition-all" data-amount="5">
                        Buy for 5U
                    </button>
                </div>
                
                <!-- VIP Ticket -->
                <div class="bg-white p-8 rounded-2xl border-4 border-black shadow-xl transform rotate-random hover:scale-105 transition-all" style="--rotation: -1deg">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">üëë</div>
                        <h3 class="text-2xl font-bold text-memePurple">VIP Ticket</h3>
                        <div class="text-4xl font-bold text-memeYellow mt-2">10U</div>
                        <p class="text-gray-600 mt-2">Maximum chances</p>
                    </div>
                    <button class="buy-ticket-btn w-full bg-memePurple hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-xl border-2 border-black transform hover:scale-105 transition-all" data-amount="10">
                        Buy for 10U
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- User Info Section -->
    <section class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <!-- Wallet Info -->
                <div id="wallet-info" class="hidden bg-gradient-to-r from-memeYellow to-memePink p-6 rounded-2xl border-4 border-black shadow-xl mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div class="mb-4 md:mb-0">
                            <h3 class="text-2xl font-bold text-black mb-2">Wallet Connected</h3>
                            <div class="flex items-center space-x-4">
                                <div class="bg-black text-white px-3 py-1 rounded-lg font-mono text-sm">
                                    <span id="wallet-address">0x0000...0000</span>
                                </div>
                                <button id="disconnect-wallet" class="bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded-lg border-2 border-black">
                                    Disconnect
                                </button>
                            </div>
                        </div>
                        <div id="user-info" class="text-right">
                            <!-- User info will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- My Tickets -->
                <div class="bg-white p-6 rounded-2xl border-4 border-black shadow-xl mb-8">
                    <h3 class="text-2xl font-bold text-memeBlack mb-4">My Tickets</h3>
                    <div id="myTickets" class="space-y-3">
                        <p class="text-gray-500">Connect wallet to view tickets</p>
                    </div>
                </div>

                <!-- Referral System -->
                <div class="bg-gradient-to-br from-green-100 to-memeGreen p-6 rounded-2xl border-4 border-black shadow-xl">
                    <h3 class="text-2xl font-bold text-black mb-4">Referral System</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white p-4 rounded-xl border-2 border-black text-center">
                            <div class="text-2xl font-bold text-memeBlue" id="referral-balance">0</div>
                            <div class="text-sm text-gray-600">Referral Balance (U)</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border-2 border-black text-center">
                            <div class="text-2xl font-bold text-memeGreen" id="referral-people">0</div>
                            <div class="text-sm text-gray-600">People Invited</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border-2 border-black text-center">
                            <div class="text-2xl font-bold text-memePink" id="referral-earnings">0</div>
                            <div class="text-sm text-gray-600">Total Earnings (U)</div>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="referral-link-input" readonly class="flex-1 bg-white px-4 py-3 rounded-lg border-2 border-black font-mono text-sm" placeholder="Your referral link will appear here">
                        <button id="copy-referral-link-btn" class="bg-memeBlue hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg border-2 border-black">
                            <i class="fa fa-copy mr-2"></i> Copy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Wallet Modal -->
    <div id="wallet-modal" class="fixed inset-0 bg-black/50 z-[100] hidden">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-2xl border-4 border-black shadow-2xl overflow-hidden">
                <div class="flex items-center justify-between px-6 py-4 border-b-4 border-black bg-memeYellow">
                    <h3 class="text-xl font-extrabold">Connect Wallet</h3>
                    <button id="close-modal" class="bg-black text-white font-bold px-3 py-1 rounded-lg border-2 border-black">√ó</button>
                </div>
                <div class="p-6 space-y-4">
                    <button id="metamask-connect" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl border-2 border-black transform hover:scale-105 transition-all">
                        <i class="fa fa-fox mr-2"></i> MetaMask
                    </button>
                    <button id="walletconnect-connect" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl border-2 border-black transform hover:scale-105 transition-all">
                        <i class="fa fa-link mr-2"></i> WalletConnect
                    </button>
                    <button id="injected-connect" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-xl border-2 border-black transform hover:scale-105 transition-all">
                        <i class="fa fa-plug mr-2"></i> Injected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rules modal -->
    <div id="rules-modal" class="fixed inset-0 bg-black/50 z-[100] hidden">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl border-4 border-black shadow-2xl overflow-hidden flex flex-col">
                <div class="flex items-center justify-between px-4 py-3 border-b-4 border-black bg-memeYellow">
                    <h3 class="text-xl font-extrabold">How It Works</h3>
                    <button id="close-rules" class="bg-black text-white font-bold px-3 py-1 rounded-lg border-2 border-black">Close</button>
                </div>
                <iframe src="rules.html" class="w-full flex-1"></iframe>
            </div>
        </div>
    </div>

    <!-- History modal -->
    <div id="history-modal" class="fixed inset-0 bg-black/50 z-[100] hidden">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-6xl h-[90vh] rounded-2xl border-4 border-black shadow-2xl overflow-hidden flex flex-col">
                <div class="flex items-center justify-between px-6 py-4 border-b-4 border-black bg-memeYellow">
                    <h3 class="text-xl font-extrabold">Lottery History</h3>
                    <button id="close-history" class="bg-black text-white font-bold px-4 py-2 rounded-lg border-2 border-black">Close</button>
                </div>
                <div class="flex-1">
                    <iframe src="history.html" class="w-full h-full border-0"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Draw result modal -->
    <div id="draw-result-modal" class="fixed inset-0 bg-black/50 z-[100] hidden">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-2xl border-4 border-black shadow-2xl overflow-hidden flex flex-col">
                <div class="flex items-center justify-between px-6 py-4 border-b-4 border-black bg-memeYellow">
                    <h3 class="text-xl font-extrabold">üéâ Draw Result</h3>
                    <button id="close-draw-result" class="bg-black text-white font-bold px-4 py-2 rounded-lg border-2 border-black">Close</button>
                </div>
                 <div id="draw-result-content" class="p-6 overflow-y-auto flex-1">
                    <!-- Draw result content injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Current round -->
    <section class="pt-20 pb-16 bg-white">
        <div class="container mx-auto px-4">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold mb-2 text-memeBlack text-shadow">Current <span class="text-memePink">Round</span></h2>
                <p class="text-xl text-gray-600"><span id="remaining-count" class="font-bold text-memeBlue">10</span> people to draw!</p>
            </div>
            
            <div class="max-w-4xl mx-auto">
                <!-- Progress bar -->
                <div class="relative mb-12 md:mb-14">
                    <div class="bg-gray-200 rounded-full h-12 border-4 border-black overflow-hidden">
                        <div id="progress-bar" class="bg-gradient-to-r from-memeGreen to-memeBlue h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div id="progress-label" class="absolute top-1/2 left-[50%] -translate-x-1/2 -translate-y-1/2 z-10 pointer-events-none">
                        <div class="bg-memeYellow text-black font-bold px-4 py-1 rounded-full border-2 border-black shadow-md transform rotate-[-5deg]">
                            <span id="participant-count">0</span>/10 people
                        </div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-4 rounded-xl border-2 border-black text-center">
                        <div class="text-2xl font-bold text-memeBlue" id="total-amount">0</div>
                        <div class="text-sm text-gray-600">Total (U)</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border-2 border-black text-center">
                        <div class="text-2xl font-bold text-memeGreen" id="avg-amount">0</div>
                        <div class="text-sm text-gray-600">Average (U)</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border-2 border-black text-center">
                        <div class="text-2xl font-bold text-memePurple" id="max-amount">0</div>
                        <div class="text-sm text-gray-600">Max (U)</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border-2 border-black text-center">
                        <div class="text-2xl font-bold text-memePink" id="min-amount">0</div>
                        <div class="text-sm text-gray-600">Min (U)</div>
                    </div>
                </div>
                
                <!-- Pools -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-gradient-to-br from-yellow-100 to-memeYellow p-6 rounded-2xl border-meme shadow-xl transform rotate-random hover:scale-105 transition-all">
                        <h3 class="text-2xl font-bold mb-4 text-black">Current Pool</h3>
                        <div class="flex items-end gap-2">
                            <span id="current-pool" class="text-5xl font-bold text-black">0</span>
                            <span class="text-2xl font-bold text-gray-700 mb-1">U</span>
                        </div>
                        <div class="mt-4 text-lg">
                            <p><i class="fa fa-user mr-2"></i> <span id="current-participants">0</span> Participants</p>
                            <p><i class="fa fa-clock-o mr-2"></i> <span id="pool-status">Waiting...</span></p>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-100 to-memeBlue p-6 rounded-2xl border-meme shadow-xl transform rotate-random hover:scale-105 transition-all" style="--rotation: 2deg">
                        <h3 class="text-2xl font-bold mb-4 text-black">Grand Prize Pool</h3>
                        <div class="flex items-end gap-2">
                            <span id="grand-prize" class="text-5xl font-bold text-black">0</span>
                            <span class="text-2xl font-bold text-gray-700 mb-1">U</span>
                        </div>
                        <div class="mt-4 text-lg">
                            <p><i class="fa fa-trophy mr-2"></i> Weekly Draw</p>
                            <p><i class="fa fa-ticket mr-2"></i> <span id="total-tickets">0</span> Tickets</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-memeBlack text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <div class="mb-8">
                <h3 class="text-2xl font-bold mb-4">Join the Lottery Game</h3>
                <p class="text-gray-300 mb-6">Connect your wallet and start playing today!</p>
                <button id="footer-wallet-connect" class="bg-memeYellow hover:bg-yellow-400 text-black font-bold py-3 px-8 rounded-xl border-2 border-black transform hover:scale-105 transition-all">
                    <i class="fa fa-wallet mr-2"></i> Connect Wallet
                </button>
            </div>
            <div class="border-t border-gray-700 pt-8">
                <p class="text-gray-400">&copy; 2024 Lottery App. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 z-[200] hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl border-4 border-black text-center">
            <div class="animate-spin text-4xl mb-4">üé∞</div>
            <div id="loading-text" class="text-xl font-bold">Processing...</div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 bg-white p-4 rounded-xl border-4 border-black shadow-2xl z-[300] hidden">
        <div class="flex items-center space-x-3">
            <div id="notification-icon"></div>
            <div id="notification-message" class="font-bold"></div>
        </div>
    </div>

    <script>
        // X Layer connection - reliable RPC endpoint
        let provider = null;
        let wallet = null;
        let currentUser = null;
        let currentRound = null;
        let currentOKBPrice = 1; // default OKB price, will be updated on init
        let referralReferrer = null; // referrer from URL

        // Fetch OKB price with retry
        async function fetchOKBPrice(retryCount = 0) {
            const maxRetries = 2;
            
            try {
                // Create AbortController for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
                
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=okb&vs_currencies=usd', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.okb && data.okb.usd) {
                    currentOKBPrice = data.okb.usd;
                    console.log('Current OKB price:', currentOKBPrice, 'USD');
                    updateOKBPriceDisplay();
                    return currentOKBPrice;
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('OKB price fetch timed out');
                } else {
                    console.error('Failed to fetch OKB price:', error);
                }
                
                // Retry logic
                if (retryCount < maxRetries) {
                    console.log(`Retrying OKB price fetch (${retryCount + 1}/${maxRetries})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // Exponential backoff
                    return fetchOKBPrice(retryCount + 1);
                }
                
                // All retries failed, use default
                console.warn('All OKB price fetch attempts failed, using default 1 USD');
                currentOKBPrice = 1;
                updateOKBPriceDisplay();
                return 1;
            }
        }

        // Update OKB price display
        function updateOKBPriceDisplay() {
            const okbPriceElement = document.getElementById('okb-price');
            if (okbPriceElement) {
                okbPriceElement.textContent = `$${currentOKBPrice.toFixed(2)}`;
                // If price fetch failed, show warning style
                if (currentOKBPrice === 1) {
                    okbPriceElement.classList.add('text-red-500');
                    okbPriceElement.title = 'Failed to fetch price, using default';
                } else {
                    okbPriceElement.classList.remove('text-red-500');
                    okbPriceElement.title = '';
                }
            }
        }

        // Convert U to OKB (wei)
        function convertUToOKB(uAmount) {
            return Math.floor(uAmount * 1e18 / currentOKBPrice);
        }

        // DOM elements
        const connectWalletBtn = document.getElementById('wallet-connect');
        const walletInfo = document.getElementById('wallet-info');
        const walletAddress = document.getElementById('wallet-address');
        const disconnectWalletBtn = document.getElementById('disconnect-wallet');
        const buyTicketsBtn = document.getElementById('buy-tickets-btn');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        const notificationIcon = document.getElementById('notification-icon');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const walletModal = document.getElementById('wallet-modal');
        const closeModal = document.getElementById('close-modal');
        const metamaskConnect = document.getElementById('metamask-connect');
        const walletconnectConnect = document.getElementById('walletconnect-connect');
        const injectedConnect = document.getElementById('injected-connect');
        const drawResultModal = document.getElementById('draw-result-modal');
        const closeDrawResult = document.getElementById('close-draw-result');
        const drawResultContent = document.getElementById('draw-result-content');
        const referralLinkInput = document.getElementById('referral-link-input');
        const copyReferralLinkBtn = document.getElementById('copy-referral-link-btn');
        const referralBalanceEl = document.getElementById('referral-balance');
        const referralPeopleEl = document.getElementById('referral-people');
        const referralEarningsEl = document.getElementById('referral-earnings');

        // Utils
        function showNotification(message, type = 'info') {
            notificationMessage.textContent = message;
            notificationIcon.innerHTML = type === 'success' ? 
                '<i class="fa fa-check-circle text-green-500 text-xl"></i>' :
                type === 'error' ? 
                '<i class="fa fa-exclamation-circle text-red-500 text-xl"></i>' :
                '<i class="fa fa-info-circle text-blue-500 text-xl"></i>';
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // Round listener flags to avoid duplicate modals
        let activeRoundUnsubscribe = null;
        let lastResultShownRoundId = null;

        function showLoading(text = 'Processing...') {
            loadingText.textContent = text;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // Update wallet UI
        function updateWalletUI() {
            if (currentUser) {
                walletInfo.classList.remove('hidden');
                walletAddress.textContent = `${currentUser.walletAddress.slice(0, 6)}...${currentUser.walletAddress.slice(-4)}`;
                connectWalletBtn.classList.add('hidden');
            } else {
                walletInfo.classList.add('hidden');
                connectWalletBtn.classList.remove('hidden');
            }
        }

        // Update user info
        function updateUserInfo() {
            const userInfo = document.getElementById('user-info');
            if (userInfo) {
                if (currentUser) {
                    userInfo.innerHTML = `
                        <div>
                            <span class="text-gray-600">Wallet:</span>
                            <p class="text-sm font-mono break-all">${currentUser.walletAddress.slice(0, 6)}...${currentUser.walletAddress.slice(-4)}</p>
                        </div>
                        <div>
                            <span class="text-gray-600">My Tickets:</span>
                            <p class="font-semibold">${currentUser.ticketCount || 0}</p>
                        </div>
                    `;
                } else {
                    userInfo.innerHTML = '<p class="text-gray-500">Wallet not connected</p>';
                }
            }
        }

        // Wallet connect
        async function connectWallet(walletType = 'metamask') {
            try {
                showLoading('Connecting wallet...');
                
                if (!window.ethereum) {
                    showNotification('Please install MetaMask or another Ethereum wallet first', 'error');
                    hideLoading();
                    return;
                }

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const walletAddress = accounts[0];
                
                // Ensure anonymous auth is ready
                await ensureAuth();

                // Create or get user (not relying on Firebase Auth)
                currentUser = {
                    uid: walletAddress,
                    walletAddress: walletAddress
                };

                // Set up wallet object for compatibility
                wallet = {
                    publicKey: {
                        toString: () => walletAddress
                    }
                };

                // Try to create user record (non-blocking on failure)
                try {
                    const userRef = window.firestore.collection('users').doc(walletAddress);
                    await userRef.set({
                        walletAddress: walletAddress,
                        createdAt: new Date(),
                        referralCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                    }, { merge: true });
                } catch (firebaseError) {
                    console.warn('Unable to create user record, but wallet connected:', firebaseError);
                }

                updateWalletUI();
                updateUserInfo();
                loadCurrentRound();
                loadUserTickets();
                loadPoolInfo();
                showNotification('Wallet connected!', 'success');
                walletModal.classList.add('hidden');
                
            } catch (error) {
                console.error('Failed to connect wallet:', error);
                showNotification('Failed to connect wallet, please retry', 'error');
            } finally {
                hideLoading();
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            if (currentUser) {
                currentUser = null;
                updateWalletUI();
                updateUserInfo();
                showNotification('Wallet disconnected', 'info');
            }
        }

        // Load current round
        async function loadCurrentRound() {
            try {
                // Check if Firebase is ready
                if (!window.firebaseReady || !window.firestore) {
                    console.warn('Firebase not ready yet, using local data');
                    currentRound = {
                        id: null,
                        status: 'active',
                        level: 1,
                        participants: [],
                        totalAmount: 0,
                    };
                    updateRoundInfo(currentRound);
                    return;
                }
                
                const roundsQuery = window.firestore.collection('rounds')
                    .where('status', '==', 'active')
                    .orderBy('createdAt', 'desc')
                    .limit(1);
                
                const snapshot = await roundsQuery.get();
                
                if (!snapshot.empty) {
                    const round = snapshot.docs[0];
                    currentRound = {
                        id: round.id,
                        ...round.data()
                    };
                } else {
                    // If no permission to create, keep local placeholder only
                    currentRound = {
                        id: null,
                        status: 'active',
                        level: 1,
                        participants: [],
                        totalAmount: 0,
                    };
                }
                
                updateRoundInfo(currentRound);
                
            } catch (error) {
                console.error('Failed to load round:', error);
                // Fallback to local placeholder on error
                currentRound = {
                    id: null,
                    status: 'active',
                    level: 1,
                    participants: [],
                    totalAmount: 0,
                };
                updateRoundInfo(currentRound);
                showNotification('Failed to load round, using local data', 'warning');
            }
        }

        // Load user tickets
        async function loadUserTickets() {
            if (!currentUser) return;
            
            try {
                // Check if Firebase is ready
                if (!window.firebaseReady || !window.firestore) {
                    console.warn('Firebase not ready yet, showing empty tickets');
                    const myTickets = document.getElementById('myTickets');
                    if (myTickets) {
                        myTickets.innerHTML = '<p class="text-gray-500">Loading...</p>';
                    }
                    if (currentUser) {
                        currentUser.ticketCount = 0;
                        updateUserInfo();
                    }
                    return;
                }
                
                const ticketsQuery = window.firestore.collection('tickets')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(10);
                
                const snapshot = await ticketsQuery.get();
                const tickets = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const myTickets = document.getElementById('myTickets');
                if (myTickets) {
                    if (tickets.length > 0) {
                        myTickets.innerHTML = tickets.map(ticket => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <div>
                                    <div class="font-semibold">${ticket.amount}U</div>
                                    <div class="text-sm text-gray-600">
                                        ${new Date(ticket.createdAt.toDate()).toLocaleDateString()}
                                    </div>
                                </div>
                                    <div class="text-sm text-gray-500">
                                        ${ticket.status || 'Pending draw'}
                                    </div>
                            </div>
                        `).join('');
                    } else {
                        myTickets.innerHTML = '<p class="text-gray-500">No tickets</p>';
                    }
                }
                
                // Update ticket count in user info
                if (currentUser) {
                    currentUser.ticketCount = tickets.length;
                    updateUserInfo();
                }
                // Refresh referral balance
                try {
                    if (typeof firebase !== 'undefined' && firebase.functions && wallet && wallet.publicKey) {
                        const getBalance = firebase.app().functions().httpsCallable('getReferralBalance');
                        const res = await getBalance({});
                        if (res && res.data && referralBalanceEl) {
                            referralBalanceEl.textContent = (res.data.balance || 0).toString();
                        }
                        // Count invited users and total earnings
                        const myWallet = wallet.publicKey.toString();
                        // Users I invited: users where referrer == myWallet
                        const invitedSnap = await window.firestore.collection('users').where('referrer', '==', myWallet).get();
                        if (referralPeopleEl) referralPeopleEl.textContent = invitedSnap.size.toString();
                        // My total referral earnings: sum referralRewards where userId == myWallet
                        const rewardsSnap = await window.firestore.collection('referralRewards').where('userId', '==', myWallet).get();
                        let totalEarn = 0;
                        rewardsSnap.forEach(doc => { const a = Number(doc.data().amount || 0); if (!Number.isNaN(a)) totalEarn += a; });
                        if (referralEarningsEl) referralEarningsEl.textContent = totalEarn.toString();
                    }
                } catch (e) {
                    // Ignore balance fetch failure
                    console.warn('Failed to load referral data:', e);
                }
                
            } catch (error) {
                console.error('Failed to load tickets:', error);
                // On failure, fallback defaults
                if (currentUser) {
                    currentUser.ticketCount = 0;
                    updateUserInfo();
                }
                // Show empty tickets display
                const myTickets = document.getElementById('myTickets');
                if (myTickets) {
                    myTickets.innerHTML = '<p class="text-gray-500">Failed to load tickets</p>';
                }
            }
        }

        // Buy ticket
        async function buyTicket(amount) {
            if (!currentUser || !window.ethereum || !currentRound) {
                showNotification('Please connect wallet first', 'error');
                return;
            }
            
            try {
                showLoading('Processing purchase...');
                
                // Fetch current OKB price
                await fetchOKBPrice();
                
                // Calculate needed OKB amount
                const okbAmount = amount / currentOKBPrice;
                const okbWei = ethers.parseEther(okbAmount.toString());
                
                console.log(`${amount}U = ${okbAmount.toFixed(4)} OKB`);
                
                // Create OKB transfer transaction
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                
                // OKB‰ª£Â∏ÅÂêàÁ∫¶Âú∞ÂùÄÔºàX Layer‰∏ªÁΩëÔºâ
                const okbContractAddress = '0x4200000000000000000000000000000000000006';
                const projectWalletAddress = '0x520e3d52a7c9ba19d8dc606adb873cbf9419a031';
                
                // OKB‰ª£Â∏ÅÂêàÁ∫¶ABIÔºàÂè™ÂåÖÂê´transferÂáΩÊï∞Ôºâ
                const okbContract = new ethers.Contract(okbContractAddress, [
                    'function transfer(address to, uint256 amount) returns (bool)'
                ], signer);
                
                // Send OKB transfer
                const tx = await okbContract.transfer(projectWalletAddress, okbWei);
                const receipt = await tx.wait();
                const txid = receipt.transactionHash;

                // Backend verify and record purchase
                if (typeof firebase !== 'undefined' && firebase.functions) {
                    try {
                        const functionsClient = firebase.functions();
                        const record = firebase.app().functions().httpsCallable('recordPurchase');
                        await record({ amount, signature: txid, walletAddress: currentUser.walletAddress, referrer: referralReferrer });
                    } catch (fnErr) {
                        console.warn('Cloud Function recordPurchase failed, fallback to frontend write:', fnErr);
                        // Ensure wallet is properly set up before calling recordTicketPurchase
                        if (!wallet || !wallet.publicKey) {
                            wallet = {
                                publicKey: {
                                    toString: () => currentUser.walletAddress
                                }
                            };
                        }
                        await recordTicketPurchase(amount, txid);
                    }
                } else {
                    // Ensure wallet is properly set up before calling recordTicketPurchase
                    if (!wallet || !wallet.publicKey) {
                        wallet = {
                            publicKey: {
                                toString: () => currentUser.walletAddress
                            }
                        };
                    }
                    await recordTicketPurchase(amount, txid);
                }

                showNotification(`Purchased ${amount}U ticket! (${okbAmount.toFixed(4)} OKB)`, 'success');
                await loadUserTickets();
                await loadCurrentRound();
                
            } catch (error) {
                console.error('Failed to buy ticket:', error);
                showNotification('Failed to buy ticket: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Record purchase
        async function recordTicketPurchase(amount, signature) {
            try {
                // Ensure authed
                await ensureAuth();
                
                // Check if wallet is connected
                if (!wallet || !wallet.publicKey) {
                    throw new Error('Wallet not connected');
                }
                
                // Record ticket
                await window.firestore.collection('tickets').add({
                    userId: currentUser.uid,
                    walletAddress: wallet.publicKey.toString(),
                    level: amount,
                    amount: amount,
                    transactionSignature: signature,
                    referrer: referralReferrer || null,
                    createdAt: new Date(),
                });

                // Update round participants
                if (currentRound) {
                    try {
                        if (currentRound.id) {
                            const roundRef = window.firestore.collection('rounds').doc(currentRound.id);
                            const roundDoc = await roundRef.get();
                            if (roundDoc.exists) {
                                const roundData = roundDoc.data();
                                const newParticipants = [...(roundData.participants || []), {
                                    userId: currentUser.uid,
                                    walletAddress: currentUser.walletAddress,
                                    amount: amount,
                                    timestamp: new Date(),
                                }];
                                await roundRef.update({
                                    participants: newParticipants,
                                    totalAmount: (roundData.totalAmount || 0) + amount,
                                });
                                if (newParticipants.length >= 10) {
                                    await triggerLottery(roundRef.id);
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('No permission to update round, waiting for backend processing:', e);
                    }
                }
            } catch (error) {
                console.error('Failed to record purchase:', error);
            }
        }

        // Trigger draw
        async function triggerLottery(roundId) {
            // Frontend no longer updates round state directly; backend handles it
            showNotification('Round is full, waiting for backend to draw', 'info');
            await loadCurrentRound();
        }

        // Load pools info
        async function loadPoolInfo() {
            try {
                const grandPrizeDoc = await window.firestore.collection('pools').doc('grandPrize').get();
                const developerDoc = await window.firestore.collection('pools').doc('developer').get();
                
                const grandPrizeAmount = grandPrizeDoc.exists ? grandPrizeDoc.data().amount || 0 : 0;
                const developerAmount = developerDoc.exists ? developerDoc.data().amount || 0 : 0;
                
                const grandPrizeElement = document.getElementById('grand-prize');
                const developerPoolElement = document.getElementById('developer-pool');
                const totalTicketsElement = document.getElementById('total-tickets');
                
                if (grandPrizeElement) grandPrizeElement.textContent = grandPrizeAmount;
                if (developerPoolElement) developerPoolElement.textContent = developerAmount;
                
                // Calculate total tickets (simplified)
                const ticketsQuery = await window.firestore.collection('lotteryTickets').where('used', '==', false).get();
                if (totalTicketsElement) totalTicketsElement.textContent = ticketsQuery.size;
                
            } catch (error) {
                console.error('Failed to load pool info:', error);
            }
        }

        // Update round info display
        function updateRoundInfo(round) {
            if (!round) return;
            
            const participantCount = round.participants ? round.participants.length : 0;
            const totalAmount = round.totalAmount || 0;
            const avgAmount = participantCount > 0 ? (totalAmount / participantCount).toFixed(1) : 0;
            const maxAmount = round.participants ? Math.max(...round.participants.map(p => p.amount)) : 0;
            const minAmount = round.participants ? Math.min(...round.participants.map(p => p.amount)) : 0;
            
            // Update progress bar
            const progressBar = document.getElementById('progress-bar');
            const progressLabel = document.getElementById('progress-label');
            const participantCountEl = document.getElementById('participant-count');
            const remainingCountEl = document.getElementById('remaining-count');
            const totalAmountEl = document.getElementById('total-amount');
            const avgAmountEl = document.getElementById('avg-amount');
            const maxAmountEl = document.getElementById('max-amount');
            const minAmountEl = document.getElementById('min-amount');
            const currentPoolEl = document.getElementById('current-pool');
            const currentParticipantsEl = document.getElementById('current-participants');
            const poolStatusEl = document.getElementById('pool-status');
            
            if (progressBar) progressBar.style.width = `${(participantCount / 10) * 100}%`;
            if (participantCountEl) participantCountEl.textContent = participantCount;
            if (remainingCountEl) remainingCountEl.textContent = 10 - participantCount;
            if (totalAmountEl) totalAmountEl.textContent = totalAmount;
            if (avgAmountEl) avgAmountEl.textContent = avgAmount;
            if (maxAmountEl) maxAmountEl.textContent = maxAmount;
            if (minAmountEl) minAmountEl.textContent = minAmount;
            if (currentPoolEl) currentPoolEl.textContent = totalAmount;
            if (currentParticipantsEl) currentParticipantsEl.textContent = participantCount;
            if (poolStatusEl) poolStatusEl.textContent = participantCount >= 10 ? 'Drawing...' : 'Waiting...';
        }

        // Ensure authentication
        async function ensureAuth() {
            if (!currentUser) {
                throw new Error('User not authenticated');
            }
        }

        // Initialize app when Firebase is ready
        function initializeApp() {
            if (window.appInitialized) {
                console.log('App already initialized, skipping...');
                return;
            }
            
            console.log('Firebase ready, initializing app...');
            
            // Parse URL referrer param
            try {
                const url = new URL(window.location.href);
                const ref = url.searchParams.get('ref');
                if (ref && typeof ref === 'string' && ref.length > 20) {
                    referralReferrer = ref;
                }
            } catch (_) {}

            // Wallet connect button
            connectWalletBtn.addEventListener('click', () => {
                walletModal.classList.remove('hidden');
            });
            
            // Footer wallet connect button
            const footerWalletBtn = document.getElementById('footer-wallet-connect');
            if (footerWalletBtn) {
                footerWalletBtn.addEventListener('click', () => {
                    walletModal.classList.remove('hidden');
                });
            }

            // Disconnect wallet
            disconnectWalletBtn.addEventListener('click', disconnectWallet);

            // Buy tickets button
            buyTicketsBtn.addEventListener('click', () => {
                if (!currentUser) {
                    showNotification('Please connect wallet first', 'error');
                    return;
                }
                // Scroll to ticket section
                document.querySelector('#ticket-levels').scrollIntoView({ behavior: 'smooth' });
            });
            
            // Close modal
            closeModal.addEventListener('click', () => {
                walletModal.classList.add('hidden');
            });

            // Open rules
            const openRules = document.getElementById('open-rules');
            const rulesModal = document.getElementById('rules-modal');
            const closeRules = document.getElementById('close-rules');
            if (openRules && rulesModal && closeRules) {
                openRules.addEventListener('click', () => rulesModal.classList.remove('hidden'));
                closeRules.addEventListener('click', () => rulesModal.classList.add('hidden'));
                // Click overlay to close
                rulesModal.addEventListener('click', (e) => {
                    if (e.target === rulesModal) rulesModal.classList.add('hidden');
                });
            }

            // Open history
            const openHistoryBtn = document.getElementById('open-history');
            const historyModal = document.getElementById('history-modal');
            const closeHistory = document.getElementById('close-history');
            if (openHistoryBtn && historyModal && closeHistory) {
                openHistoryBtn.addEventListener('click', () => {
                    historyModal.classList.remove('hidden');
                });
                closeHistory.addEventListener('click', () => historyModal.classList.add('hidden'));
                // Click overlay to close
                historyModal.addEventListener('click', (e) => {
                    if (e.target === historyModal) historyModal.classList.add('hidden');
                });
            }

            // Draw result modal - close and overlay close
            if (closeDrawResult && drawResultModal) {
                closeDrawResult.addEventListener('click', () => drawResultModal.classList.add('hidden'));
                drawResultModal.addEventListener('click', (e) => {
                    if (e.target === drawResultModal) drawResultModal.classList.add('hidden');
                });
            }

            // Click outside modal to close
            walletModal.addEventListener('click', (e) => {
                if (e.target === walletModal) {
                    walletModal.classList.add('hidden');
                }
            });

            // Wallet provider buttons
            metamaskConnect.addEventListener('click', () => connectWallet('metamask'));
            walletconnectConnect.addEventListener('click', () => connectWallet('walletconnect'));
            injectedConnect.addEventListener('click', () => connectWallet('injected'));

            // Tier buy buttons
            document.querySelectorAll('.buy-ticket-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const amount = parseInt(button.dataset.amount);
                    buyTicket(amount);
                });
            });

            // Copy referral link
            if (copyReferralLinkBtn && referralLinkInput) {
                copyReferralLinkBtn.addEventListener('click', async () => {
                    try {
                        if (!referralLinkInput.value) return;
                        await navigator.clipboard.writeText(referralLinkInput.value);
                        showNotification('Referral link copied', 'success');
                    } catch (e) {
                        showNotification('Copy failed, please copy manually', 'error');
                    }
                });
            }

            // Smooth scroll
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) target.scrollIntoView({ behavior: 'smooth' });
                });
            });

            // Add random rotation to cards
            document.querySelectorAll('.rotate-random').forEach(el => {
                if (!el.style.getPropertyValue('--rotation')) {
                    const rotation = (Math.random() * 6) - 3;
                    el.style.setProperty('--rotation', `${rotation}deg`);
                }
            });

            // Initial load
            loadPoolInfo();
            
            // Mark app as initialized
            window.appInitialized = true;
        }

        // ÂêØÂä®ÂÆûÊó∂ÁõëÂê¨Âô®ÔºàÁ≠âÂæÖFirebaseÂ∞±Áª™Ôºâ
        function startRealtimeListeners() {
            if (!window.firestore) {
                console.warn('Firestore not ready yet, retrying in 1 second...');
                setTimeout(startRealtimeListeners, 1000);
                return;
            }
            
            console.log('Starting realtime listeners...');
            
            try {
                // Realtime listen to rounds
                window.firestore.collection('rounds')
                    .where('status', '==', 'active')
                    .onSnapshot((snapshot) => {
                        if (!snapshot.empty) {
                            const round = snapshot.docs[0];
                            currentRound = {
                                id: round.id,
                                ...round.data()
                            };
                            updateRoundInfo(currentRound);
                            if (currentRound && currentRound.id) attachRoundListener(currentRound.id);
                        }
                    });

                // Realtime listen to pools
                window.firestore.collection('pools').onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified' || change.type === 'added') {
                            loadPoolInfo();
                        }
                    });
                });
            } catch (error) {
                console.error('Failed to start realtime listeners:', error);
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Parse URL referrer param
            try {
                const url = new URL(window.location.href);
                const ref = url.searchParams.get('ref');
                if (ref && typeof ref === 'string' && ref.length > 20) {
                    referralReferrer = ref;
                }
            } catch (_) {}

            // Wallet connect button
            connectWalletBtn.addEventListener('click', () => {
                walletModal.classList.remove('hidden');
            });
            
            // Fallback initialization if Firebase is already ready
            if (window.firebaseReady) {
                initializeApp();
            }
            
            // Fallback timeout to ensure app initializes
            setTimeout(() => {
                if (!window.appInitialized) {
                    console.warn('Firebase ready callback not triggered, initializing app anyway');
                    initializeApp();
                }
            }, 3000);

            // Footer wallet connect button
            const footerWalletBtn = document.getElementById('footer-wallet-connect');
            if (footerWalletBtn) {
                footerWalletBtn.addEventListener('click', () => {
                    walletModal.classList.remove('hidden');
                });
            }

            // Disconnect wallet
            disconnectWalletBtn.addEventListener('click', disconnectWallet);

            // Buy tickets button
            buyTicketsBtn.addEventListener('click', () => {
                if (!currentUser) {
                    showNotification('Please connect wallet first', 'error');
                    return;
                }
                // Scroll to ticket section
                document.querySelector('#ticket-levels').scrollIntoView({ behavior: 'smooth' });
            });

            // Close modal
            closeModal.addEventListener('click', () => {
                walletModal.classList.add('hidden');
            });

            // Open rules
            const openRules = document.getElementById('open-rules');
            const rulesModal = document.getElementById('rules-modal');
            const closeRules = document.getElementById('close-rules');
            if (openRules && rulesModal && closeRules) {
                openRules.addEventListener('click', () => rulesModal.classList.remove('hidden'));
                closeRules.addEventListener('click', () => rulesModal.classList.add('hidden'));
                // Click overlay to close
                rulesModal.addEventListener('click', (e) => {
                    if (e.target === rulesModal) rulesModal.classList.add('hidden');
                });
            }

            // Open history
            const openHistoryBtn = document.getElementById('open-history');
            const historyModal = document.getElementById('history-modal');
            const closeHistory = document.getElementById('close-history');
            if (openHistoryBtn && historyModal && closeHistory) {
                openHistoryBtn.addEventListener('click', () => {
                    historyModal.classList.remove('hidden');
                });
                closeHistory.addEventListener('click', () => historyModal.classList.add('hidden'));
                // Click overlay to close
                historyModal.addEventListener('click', (e) => {
                    if (e.target === historyModal) historyModal.classList.add('hidden');
                });
            }

            // Draw result modal - close and overlay close
            if (closeDrawResult && drawResultModal) {
                closeDrawResult.addEventListener('click', () => drawResultModal.classList.add('hidden'));
                drawResultModal.addEventListener('click', (e) => {
                    if (e.target === drawResultModal) drawResultModal.classList.add('hidden');
                });
            }

            // Click outside modal to close
            walletModal.addEventListener('click', (e) => {
                if (e.target === walletModal) {
                    walletModal.classList.add('hidden');
                }
            });

            // Wallet provider buttons
            metamaskConnect.addEventListener('click', () => connectWallet('metamask'));
            walletconnectConnect.addEventListener('click', () => connectWallet('walletconnect'));
            injectedConnect.addEventListener('click', () => connectWallet('injected'));

            // Tier buy buttons
            document.querySelectorAll('.buy-ticket-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const amount = parseInt(button.dataset.amount);
                    buyTicket(amount);
                });
            });

            // Copy referral link
            if (copyReferralLinkBtn && referralLinkInput) {
                copyReferralLinkBtn.addEventListener('click', async () => {
                    try {
                        if (!referralLinkInput.value) return;
                        await navigator.clipboard.writeText(referralLinkInput.value);
                        showNotification('Referral link copied', 'success');
                    } catch (e) {
                        showNotification('Copy failed, please copy manually', 'error');
                    }
                });
            }

            // Smooth scroll
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });

            // Add random rotation to cards
            document.querySelectorAll('.rotate-random').forEach(el => {
                if (!el.style.getPropertyValue('--rotation')) {
                    const rotation = (Math.random() * 6) - 3;
                    el.style.setProperty('--rotation', `${rotation}deg`);
                }
            });

            // Initial load
            loadPoolInfo();
            // Ensure there is an active round (create or get via Cloud Function)
            (async () => {
                try {
                    if (typeof firebase !== 'undefined' && firebase.functions) {
                        const createOrGet = firebase.app().functions().httpsCallable('createOrGetActiveRound');
                        const res = await createOrGet({});
                        if (res && res.data) {
                            currentRound = { id: res.data.id, ...res.data };
                            updateRoundInfo(currentRound);
                            if (currentRound && currentRound.id) attachRoundListener(currentRound.id);
                        }
                    }
                } catch (e) {
                    console.warn('Failed to init active round (will rely on realtime listener):', e);
                }
            })();
            // Init OKB price display
            updateOKBPriceDisplay();
            fetchOKBPrice(); // Init fetch OKB price
            
            // Listen for wallet connection state
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        updateWalletUI();
                    }
                });
                
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });
            }
        });

        // ÂêØÂä®ÂÆûÊó∂ÁõëÂê¨Âô®ÔºàÁ≠âÂæÖFirebaseÂ∞±Áª™Ôºâ
        function startRealtimeListeners() {
            if (!window.firestore) {
                console.warn('Firestore not ready yet, retrying in 1 second...');
                setTimeout(startRealtimeListeners, 1000);
                return;
            }
            
            console.log('Starting realtime listeners...');
            
            try {
                // Realtime listen to rounds
                window.firestore.collection('rounds')
                    .where('status', '==', 'active')
                    .onSnapshot((snapshot) => {
                        if (!snapshot.empty) {
                            const round = snapshot.docs[0];
                            currentRound = {
                                id: round.id,
                                ...round.data()
                            };
                            updateRoundInfo(currentRound);
                            if (currentRound && currentRound.id) attachRoundListener(currentRound.id);
                        }
                    });

                // Realtime listen to pools
                window.firestore.collection('pools').onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified' || change.type === 'added') {
                            loadPoolInfo();
                        }
                    });
                });
            } catch (error) {
                console.error('Failed to start realtime listeners:', error);
            }
        }
        
        // Âú®FirebaseÂ∞±Áª™ÂêéÂêØÂä®ÂÆûÊó∂ÁõëÂê¨Âô®
        if (typeof onFirebaseReady === 'function') {
            const originalOnFirebaseReady = onFirebaseReady;
            window.onFirebaseReady = function() {
                originalOnFirebaseReady();
                // Âª∂ËøüÂêØÂä®ÂÆûÊó∂ÁõëÂê¨Âô®ÔºåÁ°Æ‰øùFirebaseÂÆåÂÖ®Â∞±Áª™
                setTimeout(startRealtimeListeners, 100);
                // Initialize the app
                initializeApp();
            };
        }
    </script>
</body>
</html>
