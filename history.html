<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²è®°å½• | æŠ½å¥–åº”ç”¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        memeYellow: '#FFDD00',
                        memePink: '#FF2E93',
                        memeBlue: '#00A3FF',
                        memeGreen: '#00E08E',
                        memePurple: '#9D4EDD',
                        memeBlack: '#121212',
                    },
                    fontFamily: {
                        meme: ['"Comic Sans MS"', '"Comic Neue"', 'cursive'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-meme">
    <!-- å¯¼èˆªæ  -->
    <nav class="sticky top-0 z-50 bg-memeYellow border-b-4 border-black shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="text-4xl">ğŸ¯</div>
                <h1 class="text-2xl md:text-3xl font-bold text-shadow">æŠ½å¥–å†å²è®°å½•</h1>
            </div>
            <a href="index.html" class="bg-memeBlue hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg border-2 border-black transform hover:scale-105 transition-all shadow-md">
                <i class="fa fa-home mr-2"></i> è¿”å›é¦–é¡µ
            </a>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container mx-auto px-4 py-8">
        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-6 rounded-xl border-2 border-black text-center shadow-lg">
                <div class="text-3xl font-bold text-memeBlue" id="total-rounds">0</div>
                <div class="text-sm text-gray-600">æ€»è½®æ¬¡</div>
            </div>
            <div class="bg-white p-6 rounded-xl border-2 border-black text-center shadow-lg">
                <div class="text-3xl font-bold text-memeGreen" id="total-participants">0</div>
                <div class="text-sm text-gray-600">æ€»å‚ä¸äººæ•°</div>
            </div>
            <div class="bg-white p-6 rounded-xl border-2 border-black text-center shadow-lg">
                <div class="text-3xl font-bold text-memePink" id="total-prize">0</div>
                <div class="text-sm text-gray-600">æ€»å¥–é‡‘æ± (U)</div>
            </div>
            <div class="bg-white p-6 rounded-xl border-2 border-black text-center shadow-lg">
                <div class="text-3xl font-bold text-memePurple" id="avg-prize">0</div>
                <div class="text-sm text-gray-600">å¹³å‡å¥–é‡‘(U)</div>
            </div>
        </div>

        <!-- ç­›é€‰å™¨ -->
        <div class="bg-white p-4 rounded-xl border-2 border-black mb-6 shadow-lg">
            <div class="flex flex-wrap gap-4 items-center">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">çŠ¶æ€ç­›é€‰</label>
                    <select id="status-filter" class="border-2 border-black rounded-lg px-3 py-2">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="active">è¿›è¡Œä¸­</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">æ—¶é—´èŒƒå›´</label>
                    <select id="time-filter" class="border-2 border-black rounded-lg px-3 py-2">
                        <option value="7">æœ€è¿‘7å¤©</option>
                        <option value="30">æœ€è¿‘30å¤©</option>
                        <option value="90">æœ€è¿‘90å¤©</option>
                        <option value="all">å…¨éƒ¨æ—¶é—´</option>
                    </select>
                </div>
                <button id="refresh-btn" class="bg-memeBlue hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg border-2 border-black transform hover:scale-105 transition-all">
                    <i class="fa fa-refresh mr-2"></i> åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- è½®æ¬¡åˆ—è¡¨ -->
        <div id="rounds-container" class="space-y-6">
            <!-- è½®æ¬¡å¡ç‰‡å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
        <div class="text-center mt-8">
            <button id="load-more" class="bg-memeYellow hover:bg-yellow-400 text-black font-bold py-3 px-6 rounded-lg border-2 border-black transform hover:scale-105 transition-all shadow-lg hidden">
                <i class="fa fa-plus mr-2"></i> åŠ è½½æ›´å¤š
            </button>
        </div>
    </div>

    <!-- è½®æ¬¡è¯¦æƒ…å¼¹çª— -->
    <div id="round-detail-modal" class="fixed inset-0 bg-black/50 z-[100] hidden">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-2xl border-4 border-black shadow-2xl overflow-hidden flex flex-col">
                <div class="flex items-center justify-between px-6 py-4 border-b-4 border-black bg-memeYellow">
                    <h3 class="text-xl font-bold">è½®æ¬¡è¯¦æƒ…</h3>
                    <button id="close-detail-modal" class="bg-black text-white font-bold px-4 py-2 rounded-lg border-2 border-black">å…³é—­</button>
                </div>
                <div id="round-detail-content" class="p-6 overflow-y-auto flex-1">
                    <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyA5Z5ieEbAcfQX0kxGSn9ldGXhzvAwx_8M",
            authDomain: "chat-294cc.firebaseapp.com",
            databaseURL: "https://chat-294cc-default-rtdb.firebaseio.com",
            projectId: "chat-294cc",
            storageBucket: "chat-294cc.firebasestorage.app",
            messagingSenderId: "913615304269",
            appId: "1:913615304269:web:0274ffaccb8e6b678e4e04",
            measurementId: "G-SJR9NDW86B"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let rounds = [];
        let currentPage = 0;
        const pageSize = 10;
        let hasMore = true;

        // åŠ è½½è½®æ¬¡æ•°æ®
        async function loadRounds() {
            try {
                const statusFilter = document.getElementById('status-filter').value;
                const timeFilter = document.getElementById('time-filter').value;
                
                let query = db.collection('rounds').orderBy('createdAt', 'desc');
                
                if (statusFilter) {
                    query = query.where('status', '==', statusFilter);
                }
                
                if (timeFilter !== 'all') {
                    const daysAgo = new Date();
                    daysAgo.setDate(daysAgo.getDate() - parseInt(timeFilter));
                    query = query.where('createdAt', '>=', daysAgo);
                }
                
                const snapshot = await query.limit(pageSize).get();
                rounds = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                displayRounds();
                updateStats();
                
                hasMore = snapshot.docs.length === pageSize;
                document.getElementById('load-more').classList.toggle('hidden', !hasMore);
                
            } catch (error) {
                console.error('åŠ è½½è½®æ¬¡å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºè½®æ¬¡åˆ—è¡¨
        function displayRounds() {
            const container = document.getElementById('rounds-container');
            container.innerHTML = rounds.map(round => `
                <div class="bg-white rounded-xl border-2 border-black shadow-lg overflow-hidden">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-memeBlack">è½®æ¬¡ ${round.id.slice(-8)}</h3>
                                <p class="text-sm text-gray-600">
                                    åˆ›å»ºæ—¶é—´: ${round.createdAt ? new Date(round.createdAt.toDate()).toLocaleString() : 'æœªçŸ¥'}
                                </p>
                            </div>
                            <div class="text-right">
                                <span class="inline-block px-3 py-1 rounded-full text-sm font-bold ${
                                    round.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                                }">
                                    ${round.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-memeBlue">${round.participants ? round.participants.length : 0}</div>
                                <div class="text-sm text-gray-600">å‚ä¸äººæ•°</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-memeGreen">${round.totalAmount || 0}</div>
                                <div class="text-sm text-gray-600">æ€»é‡‘é¢(U)</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-memePink">${round.prizeAmount || 0}</div>
                                <div class="text-sm text-gray-600">å¥–é‡‘(U)</div>
                            </div>
                        </div>
                        
                        ${round.winner ? `
                            <div class="bg-memeYellow p-4 rounded-lg border-2 border-black mb-4">
                                <h4 class="font-bold text-lg mb-2">ğŸ† ä¸­å¥–è€…</h4>
                                <p class="text-sm">é’±åŒ…åœ°å€: ${round.winner.walletAddress}</p>
                                <p class="text-sm">ä¸­å¥–é‡‘é¢: ${round.prizeAmount || 0}U</p>
                            </div>
                        ` : ''}
                        
                        <button onclick="showRoundDetail('${round.id}')" class="w-full bg-memeBlue hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg border-2 border-black transform hover:scale-105 transition-all">
                            <i class="fa fa-eye mr-2"></i> æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function updateStats() {
            try {
                const snapshot = await db.collection('rounds').get();
                const allRounds = snapshot.docs.map(doc => doc.data());
                
                const totalRounds = allRounds.length;
                const totalParticipants = allRounds.reduce((sum, round) => sum + (round.participants ? round.participants.length : 0), 0);
                const totalPrize = allRounds.reduce((sum, round) => sum + (round.totalAmount || 0), 0);
                const avgPrize = totalRounds > 0 ? (totalPrize / totalRounds).toFixed(1) : 0;
                
                document.getElementById('total-rounds').textContent = totalRounds;
                document.getElementById('total-participants').textContent = totalParticipants;
                document.getElementById('total-prize').textContent = totalPrize;
                document.getElementById('avg-prize').textContent = avgPrize;
                
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºè½®æ¬¡è¯¦æƒ…
        async function showRoundDetail(roundId) {
            try {
                const roundDoc = await db.collection('rounds').doc(roundId).get();
                if (!roundDoc.exists) {
                    alert('è½®æ¬¡ä¸å­˜åœ¨');
                    return;
                }
                
                const round = { id: roundDoc.id, ...roundDoc.data() };
                const content = document.getElementById('round-detail-content');
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-2">åŸºæœ¬ä¿¡æ¯</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>è½®æ¬¡ID:</strong> ${round.id}</div>
                                <div><strong>çŠ¶æ€:</strong> ${round.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}</div>
                                <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${round.createdAt ? new Date(round.createdAt.toDate()).toLocaleString() : 'æœªçŸ¥'}</div>
                                <div><strong>å¤„ç†æ—¶é—´:</strong> ${round.processedAt ? new Date(round.processedAt.toDate()).toLocaleString() : 'æœªå¤„ç†'}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-2">å¥–æ± åˆ†é…</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>æ€»é‡‘é¢:</strong> ${round.totalAmount || 0}U</div>
                                <div><strong>ä¸­å¥–é‡‘é¢:</strong> ${round.prizeAmount || 0}U</div>
                                <div><strong>å›è´­é‡‘é¢:</strong> ${round.buybackAmount || 0}U</div>
                                <div><strong>æ¨èè¿”ä½£:</strong> ${round.referralAmount || 0}U</div>
                                <div><strong>æ€»å¥–æ± :</strong> ${round.grandPrizeAmount || 0}U</div>
                                <div><strong>å¼€å‘è€…:</strong> ${round.developerAmount || 0}U</div>
                            </div>
                        </div>
                        
                        ${round.winner ? `
                            <div class="bg-memeYellow p-4 rounded-lg border-2 border-black">
                                <h4 class="font-bold text-lg mb-2">ğŸ† ä¸­å¥–è€…ä¿¡æ¯</h4>
                                <div class="space-y-2 text-sm">
                                    <div><strong>é’±åŒ…åœ°å€:</strong> ${round.winner.walletAddress}</div>
                                    <div><strong>ç”¨æˆ·ID:</strong> ${round.winner.userId}</div>
                                    <div><strong>å‚ä¸é‡‘é¢:</strong> ${round.winner.amount}U</div>
                                    <div><strong>å‚ä¸æ—¶é—´:</strong> ${round.winner.timestamp ? new Date(round.winner.timestamp.toDate()).toLocaleString() : 'æœªçŸ¥'}</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-2">å‚ä¸è€…åˆ—è¡¨ (${round.participants ? round.participants.length : 0}äºº)</h4>
                            <div class="max-h-60 overflow-y-auto">
                                ${round.participants ? round.participants.map((participant, index) => `
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200 ${participant.walletAddress === round.winner?.walletAddress ? 'bg-memeYellow' : ''}">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-sm font-bold">#${index + 1}</span>
                                            <div>
                                                <div class="text-sm font-medium">${participant.walletAddress}</div>
                                                <div class="text-xs text-gray-500">${participant.timestamp ? new Date(participant.timestamp.toDate()).toLocaleString() : 'æœªçŸ¥'}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-bold">${participant.amount}U</div>
                                            ${participant.walletAddress === round.winner?.walletAddress ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">ğŸ† ä¸­å¥–</span>' : ''}
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-500">æš‚æ— å‚ä¸è€…</p>'}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('round-detail-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('åŠ è½½è½®æ¬¡è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½è¯¦æƒ…å¤±è´¥');
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            // ç­›é€‰å™¨å˜åŒ–
            document.getElementById('status-filter').addEventListener('change', loadRounds);
            document.getElementById('time-filter').addEventListener('change', loadRounds);
            
            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refresh-btn').addEventListener('click', loadRounds);
            
            // åŠ è½½æ›´å¤š
            document.getElementById('load-more').addEventListener('click', async () => {
                currentPage++;
                await loadRounds();
            });
            
            // å…³é—­è¯¦æƒ…å¼¹çª—
            document.getElementById('close-detail-modal').addEventListener('click', () => {
                document.getElementById('round-detail-modal').classList.add('hidden');
            });
            
            // ç‚¹å‡»é®ç½©å…³é—­
            document.getElementById('round-detail-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('round-detail-modal')) {
                    document.getElementById('round-detail-modal').classList.add('hidden');
                }
            });
            
            // åˆå§‹åŠ è½½
            loadRounds();
        });
    </script>
</body>
</html>
